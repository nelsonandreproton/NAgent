# 🤖 Agent Orchestrator

An intelligent agent orchestrator that provides daily summaries by coordinating Gmail and Google Calendar agents using local Ollama LLM (gemma2:2b) with Telegram notification support.

## ✨ Features

- 📧 **Gmail Agent**: Fetches and summarizes unread emails with intelligent filters
- 📅 **Calendar Agent**: Analyzes daily meetings and identifies conflicts
- 🤖 **LLM Integration**: Uses local Ollama instance with gemma2:2b model
- 📱 **Telegram Notifications**: Sends daily summaries directly to your Telegram
- 🌍 **Multi-language**: Support for Portuguese (PT/BR), English, Spanish and more
- ⏰ **Flexible Scheduling**: On-demand or daily automated execution
- 📊 **Rich Output**: JSON, text or HTML formats
- 🎨 **CLI Interface**: Rich terminal interface with colors and tables
- 🔧 **Configurable**: Extensive YAML-based configuration system

## 🚀 Quick Start

### 1. Prerequisites

- Python 3.8+
- [Ollama](https://ollama.ai/) installed and running
- Google Cloud Console project with Gmail and Calendar APIs enabled
- (Optional) Configured Telegram bot

### 2. Installation

```bash
# Clone or download the project
cd NAgent

# Install dependencies
pip install -r requirements.txt

# Install and start Ollama with gemma2:2b model
ollama pull gemma2:2b
ollama serve
```

### 3. Google API Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing one
3. Enable Gmail API and Calendar API
4. Create OAuth 2.0 credentials (Desktop Application)
5. Download `credentials.json` and place in `credentials/` directory

### 4. Telegram Bot Setup (Optional)

1. Open Telegram and search for [@BotFather](https://t.me/BotFather)
2. Send `/newbot` command and follow instructions
3. Save the bot token (format: `123456:ABC-DEF1234...`)
4. Get your Chat ID:
   - Send a message to [@userinfobot](https://t.me/userinfobot) 
   - Copy your numeric ID (e.g., `123456789`)
5. Test the bot by sending it a message first

### 5. Configuration

```bash
# Copy environment template
cp .env.template .env

# Edit settings
vim .env
```

### 6. First Test

```bash
# Check system status
python main.py --status

# Generate summary immediately
python main.py --run-now

# Start scheduled mode
python main.py --schedule
```

## ⚙️ Configuration

### Environment Variables (.env)

```bash
# Google API
GOOGLE_CREDENTIALS_PATH=credentials/credentials.json

# Ollama
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=gemma2:2b

# Telegram (Optional)
TELEGRAM_ENABLED=true
TELEGRAM_BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
TELEGRAM_CHAT_ID=123456789

# Scheduling
DAILY_SUMMARY_TIME=09:00
TIMEZONE=UTC

# Output
OUTPUT_FORMAT=json
SUMMARY_LENGTH=medium
```

### Main Configuration (config/config.yaml)

The system uses a comprehensive YAML configuration file with sections for:

- **Schedule**: Automated summary timing
- **Language**: Language configuration (pt-pt, pt-br, en, es, fr, de, it)
- **Ollama**: LLM model and generation settings
- **Google API**: Authentication and scope configuration
- **Gmail**: Email filtering and processing options
- **Calendar**: Event selection and categorization
- **Telegram**: Notification configuration
- **Summary**: Output format and detail levels
- **Logging**: Log levels and file output

#### Language Configuration

```yaml
language:
  # Default language for summaries (pt-pt, pt-br, en, es, fr, de, it)
  default: "en"
  # Date format for the selected language
  date_format: "%Y-%m-%d"
  # Time format for the selected language  
  time_format: "%H:%M"
```

#### Telegram Configuration

```yaml
telegram:
  # Send daily summary automatically
  send_daily_summary: true
  # Send error notifications
  send_error_notifications: true
  # Send system status updates
  send_status_updates: false
  # Message format (html, markdown, text)
  message_format: "html"
```

## 📱 Using with Telegram

### Quick Setup

1. **Create Bot**: Talk to @BotFather → `/newbot`
2. **Get Chat ID**: Talk to @userinfobot
3. **Configure .env**:
   ```bash
   TELEGRAM_ENABLED=true
   TELEGRAM_BOT_TOKEN=your_token_here
   TELEGRAM_CHAT_ID=your_chat_id_here
   ```
4. **Test**: `python main.py --run-now`

### Notification Types

- 📋 **Daily Summaries**: Formatted emails and meetings
- ⚠️ **Error Notifications**: When something fails
- 🔍 **System Status**: Connectivity checks
- ⏰ **Scheduled Runs**: Start/finish of automated tasks

### Example Telegram Message

```
🤖 Daily Summary - Agent Orchestrator
📅 2024-01-15

📧 Unread emails: 12
📩 Recent (3h): 3

📅 Meetings today: 4
💻 Virtual: 2
⏰ Total duration: 3.5h

📋 Daily Briefing:
[Intelligent summary generated by LLM]

Generated at 09:00
```

## 🌍 Multi-language Support

### Available Languages

- **pt-pt**: Portuguese (Portugal) (default)
- **pt-br**: Portuguese (Brazil)
- **en**: English
- **es**: Spanish
- **fr**: French
- **de**: German
- **it**: Italian

### How to Change Language

Edit `config/config.yaml`:
```yaml
language:
  default: "en"  # For English
```

Language affects:
- Telegram messages
- Date/time formats
- System notifications
- CLI interface

## 💻 Usage Examples

### Command Line Interface

```bash
# System status check
python main.py --status

# Immediate summary generation
python main.py --run-now

# Scheduled mode (runs daily at configured time)
python main.py --schedule

# Debug mode with verbose logging
python main.py --run-now --debug

# Use custom configuration file
python main.py --config my-config.yaml --run-now
```

### Programmatic Usage

```python
from main import AgentOrchestrator

# Initialize orchestrator
orchestrator = AgentOrchestrator("config/config.yaml")

# Check system status
status = orchestrator.check_system_status()

# Generate daily summary
summary = orchestrator.generate_daily_summary()

# Display in terminal
orchestrator.display_summary(summary)
```

## 📊 Output Formats

### JSON Format
```json
{
  "timestamp": "2024-01-15T09:00:00",
  "email_summary": "You have 12 unread emails...",
  "calendar_summary": "You have 4 meetings today...",
  "unified_summary": "Daily Briefing: Here's your day at a glance...",
  "statistics": {
    "email": {"total_unread": 12, "recent_count": 3},
    "calendar": {"total_events": 4, "virtual_meetings": 2}
  }
}
```

### Text Format
Unified summary in plain text, perfect for notifications.

### HTML Format  
Rich HTML output with styling, perfect for email reports or web dashboards.

## 🏗️ Architecture

```
Agent Orchestrator
├── main.py                    # Main orchestrator and CLI
├── services/
│   ├── google_auth.py         # Google OAuth 2.0 management
│   ├── llm_service.py         # Ollama LLM client
│   ├── telegram_service.py    # Telegram bot integration
│   └── translations.py       # Translation service
├── agents/
│   ├── gmail_agent.py         # Gmail API integration
│   └── calendar_agent.py      # Calendar API integration
├── config/
│   └── config.yaml           # Main configuration
├── credentials/              # Google API credentials
├── summaries/               # Generated summary files
└── logs/                    # Application logs
```

### Component Details

#### Gmail Agent
- Fetches unread emails with configurable filters
- Extracts sender, subject and content preview
- Groups emails by sender and topic
- Identifies urgent/important emails
- Provides fallback summaries if LLM unavailable

#### Calendar Agent  
- Retrieves today's calendar events
- Categorizes meetings (virtual, in-person, types)
- Calculates duration and identifies conflicts
- Extracts attendee and location information
- Provides schedule optimization suggestions

#### Ollama Service
- Connects to local Ollama instance
- Supports custom prompts and templates
- Manages temperature and token configuration
- Provides error handling and fallbacks
- Optimized for gemma2:2b model

#### Authentication Manager
- Handles OAuth 2.0 flow automatically
- Manages token refresh and storage
- Provides connection testing utilities
- Supports credential revocation

## 🔧 Advanced Settings

### Email Filtering
```yaml
gmail:
  labels: ["IMPORTANT", "CATEGORY_PERSONAL"]
  exclude_senders: ["noreply@example.com"]
  max_age_hours: 24
```

### Calendar Customization
```yaml
calendar:
  include_all_day: true
  min_duration_minutes: 15
  days_ahead: 1
```

### LLM Customization
```yaml
ollama:
  temperature: 0.7
  max_tokens: 1000
  timeout: 30
```

### Scheduled Execution
```yaml
schedule:
  enabled: true
  daily_time: "08:30"
  timezone: "America/New_York"
```

## 🔍 Troubleshooting

### Common Issues

**Ollama Connection Failed**
```bash
# Check if Ollama is running
curl http://localhost:11434/api/tags

# Start Ollama if needed
ollama serve

# Pull model if missing
ollama pull gemma2:2b
```

**Google Authentication Errors**
```bash
# Check if credentials file exists
ls -la credentials/credentials.json

# Remove cached tokens to re-authenticate
rm credentials/token.json

# Check API quotas in Google Cloud Console
```

**Telegram Issues**
```bash
# Check if bot token and chat ID are correct
# Make sure you sent a message to the bot first
# Test manual connection:
curl -X POST "https://api.telegram.org/botYOUR_TOKEN/sendMessage" \
     -H "Content-Type: application/json" \
     -d '{"chat_id": "YOUR_CHAT_ID", "text": "test"}'
```

**Permission Errors**
```bash
# Make sure main.py is executable
chmod +x main.py

# Check directory permissions
chmod 755 credentials/ config/ logs/
```

### Debug Mode

Enable comprehensive logging:
```bash
python main.py --run-now --debug
```

This provides detailed information about:
- API calls and responses
- Authentication flow
- LLM generation process
- Error stack traces

### System Status Check

Always start troubleshooting with:
```bash
python main.py --status
```

This verifies:
- ✅ Ollama availability and model access
- ✅ Google API authentication status
- ✅ Gmail and Calendar API connectivity
- ✅ Telegram Bot connection
- ✅ Configuration validity

## 🔐 Security Notes

- Credentials are stored locally and never transmitted
- OAuth tokens are encrypted and auto-refreshed
- API calls use official Google client libraries
- LLM processing happens entirely locally (via Ollama)
- Sensitive data is excluded from logs
- Never commit .env files or credentials to public repositories

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable  
5. Update documentation
6. Submit a pull request

## 📄 License

MIT License - see LICENSE file for details.

## 🆘 Support

For issues and questions:
1. Check the troubleshooting section above
2. Review logs in `logs/orchestrator.log`
3. Run system status check
4. Consult `TELEGRAM_SETUP_EN.md` for Telegram configuration
5. Create an issue with system details and logs

## 📈 Roadmap

- [ ] Support for multiple calendars
- [ ] Integration with more LLMs (OpenAI, Claude, etc.)
- [ ] Web dashboard interface
- [ ] Plugins for other services (Slack, Discord, etc.)
- [ ] Email sentiment analysis
- [ ] Intelligent response suggestions

---

**Agent Orchestrator** - Simplify your daily routine with artificial intelligence! 🚀